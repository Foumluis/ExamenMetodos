{% extends 'base.html' %}

{% block title %}Presencia Geográfica Pobre en EEUU{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="bi bi-map me-2"></i>Presencia Geográfica Pobre en EEUU</h2>
            <p class="text-muted">Análisis de las zonas con baja presencia de ventas en Estados Unidos</p>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Mapa de Presencia Geográfica</h5>
                </div>
                <div class="card-body">
                    <div id="presenciaMap" style="height: 500px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Estados con Menor Presencia</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Estado</th>
                                <th>Cantidad de Ventas</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in bottom_10_data %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ item.estado }}</td>
                                <td>{{ item.cantidad }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Recomendaciones</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li><i class="bi bi-check-circle text-success me-2"></i>Los estados con mayores montos de venta, como Montana, Illinois y California, concentran gran parte de los ingresos totales, reflejando una alta presencia comercial en el norte y oeste del país</li>
                        <li><i class="bi bi-check-circle text-success me-2"></i>Las diferencias de ventas entre estados son notables, lo que indica una distribución geográfica desigual que podría limitar el crecimiento nacional de la marca.</li>
                        <li><i class="bi bi-check-circle text-success me-2"></i>Los estados con menor presencia podrían estar siendo afectados por falta de distribución, baja visibilidad publicitaria o preferencias locales distintas, factores que deben ser analizados en profundidad.</li>

                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>



{{ todos_estados|json_script:"todos_estados" }}
{{ todos_codigos|json_script:"todos_codigos" }}
{{ todas_cantidades|json_script:"todas_cantidades" }}
{{ bottom_10_data|json_script:"bottom_10_data" }}

{% endblock %}

{% block extra_js %}
<script>
    const todosEstados = JSON.parse(document.getElementById('todos_estados').textContent);
    const todosCodigos = JSON.parse(document.getElementById('todos_codigos').textContent);
    const todasCantidades = JSON.parse(document.getElementById('todas_cantidades').textContent);
    const bottom10Data = JSON.parse(document.getElementById('bottom_10_data').textContent);

    const mapData = [{
        type: 'choropleth',
        locationmode: 'USA-states',
        locations: todosCodigos,
        z: todasCantidades,
        text: todosEstados.map((estado, i) => `${estado}<br>Ventas: ${todasCantidades[i]}`),
        hoverinfo: 'text',
        colorscale: [
            [0, 'rgb(255, 100, 100)'],
            [0.2, 'rgb(255, 150, 100)'],
            [0.4, 'rgb(255, 200, 100)'],
            [0.6, 'rgb(255, 255, 150)'],
            [0.8, 'rgb(150, 255, 150)'],
            [1, 'rgb(50, 200, 50)']
        ],
        reversescale: false,
        colorbar: {
            title: {
                text: 'Cantidad de<br>Ventas',
                side: 'right'
            },
            thickness: 20,
            len: 0.7,
            tickformat: 'd'
        },
        marker: {
            line: {
                color: 'rgb(255, 255, 255)',
                width: 2
            }
        }
    }];

    const mapLayout = {
        title: {
            text: 'Presencia de Ventas por Estado en EE.UU.',
            font: {
                size: 20,
                color: '#1e3c72',
                family: 'Arial, sans-serif'
            }
        },
        geo: {
            scope: 'usa',
            projection: {
                type: 'albers usa'
            },
            showlakes: true,
            lakecolor: 'rgb(255, 255, 255)'
        },
        height: 500,
        margin: {
            l: 0,
            r: 0,
            t: 50,
            b: 0
        }
    };

    const config = {
        responsive: true,
        displayModeBar: true,
        displaylogo: false,
        modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
    };

    // Intentar crear el mapa con manejo de errores
    try {
        Plotly.newPlot('presenciaMap', mapData, mapLayout, config);
        console.log('Mapa creado exitosamente');
    } catch (error) {
        console.error('Error al crear el mapa:', error);
    }
</script>
{% endblock %}
